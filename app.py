import os
import re
import random
import google.generativeai as genai
from flask import Flask, request, abort
from linebot.v3.messaging import MessagingApi, Configuration, ApiClient, ReplyMessageRequest, TextMessage
from linebot.v3.webhook import WebhookHandler, MessageEvent
from linebot.v3.exceptions import InvalidSignatureError

# â–ªãƒ»ãƒ»â–ª ç’°å¢ƒå¤‰æ•°ã®è¨­å®š
os.environ["LINE_CHANNEL_ACCESS_TOKEN"] = "VQLW+Jg0yrKEh/CctElX5j5qYwsMJqDNdqC6mo4CdVw9iXZowCQ23LITmdGv7ZhC6MFD0DV26JqBwRRyOhEPz/fShuz7gti2BDfvXYqwWy1sE6Esk3ymqkV8WCgu0nd8xoEPRzyS3rsWwx5utKszzgdB04t89/1O/w1cDnyilFU="
os.environ["LINE_CHANNEL_SECRET"] = "dbb5c67578f6efc325f2d6011261db56"
os.environ["GEMINI_API_KEY"] = "AIzaSyAEoWodsKPJC4QSsuohkPGSrKXO_ngHNZU"

LINE_CHANNEL_ACCESS_TOKEN = os.getenv["LINE_CHANNEL_ACCESS_TOKEN"]
LINE_CHANNEL_SECRET = os.getenv["LINE_CHANNEL_SECRET"]
GEMINI_API_KEY = os.getenv["GEMINI_API_KEY"]

config = Configuration(access_token=LINE_CHANNEL_ACCESS_TOKEN)
api_client = ApiClient(configuration=config)
line_bot_api = MessagingApi(api_client)
handler = WebhookHandler(LINE_CHANNEL_SECRET)



config = Configuration(access_token=LINE_CHANNEL_ACCESS_TOKEN)
api_client = ApiClient(configuration=config)
line_bot_api = MessagingApi(api_client)
handler = WebhookHandler(LINE_CHANNEL_SECRET)

# Flask & GeminiÂ 
app = Flask(__name__)
genai.configure(api_key=GEMINI_API_KEY)
model = genai.GenerativeModel("gemini-2.0-flash")

# ãƒ¦ãƒ¼ã‚¶ãƒ¼ã”ã¨ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³æƒ…å ±
user_sessions = {}

# ã‚¿ãƒ­ãƒƒãƒˆã‚«ãƒ¼ãƒ‰ã®æ„å‘³
CARD_MEANINGS = {
    "å¤ªé™½": "æˆåŠŸã€é”æˆã€å–œã³",
    "æ‚ªé­”": "èª˜æƒ‘ã€åŸ·ç€ã€ä¾å­˜",
    "å¡”": "å´©å£Šã€å¤‰åŒ–ã€ç½é›£",
    "æ‹äººãŸã¡": "èª¿å’Œã€é¸æŠã€æ‹æ„›",
    "ã‚«ãƒƒãƒ—ã®6": "æ‡ã‹ã—ã•ã€æœªç·´ã€è´ˆã‚Šç‰©",
    "å¥³å¸": "è±Šç©£ã€è‚²æˆã€æ¯æ€§",
}

def get_user_name(event):
    """
    ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®åå‰ã‚’å–å¾—ã™ã‚‹é–¢æ•°ã€‚
    LINEã®ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«æƒ…å ±ã‹ã‚‰å–å¾—ã‚’è©¦ã¿ã€å¤±æ•—ã—ãŸå ´åˆã¯Noneã‚’è¿”ã™ã€‚
    """
    try:
        profile = line_bot_api.get_profile(event.source.user_id)
        return profile.display_name
    except Exception as e:
        print(f"ãƒ¦ãƒ¼ã‚¶ãƒ¼åå–å¾—ã‚¨ãƒ©ãƒ¼: {e}")
        return None

@app.route("/callback", methods=["POST"])
def callback():
    signature = request.headers["X-Line-Signature"]
    body = request.get_data(as_text=True)
    try:
        handler.handle(body, signature)
    except InvalidSignatureError:
        abort(400)
    return "OK"

def send_reply(event, message):
    line_bot_api.reply_message(
        ReplyMessageRequest(
            reply_token=event.reply_token,
            messages=[TextMessage(text=message)]
        )
    )

@handler.add(MessageEvent)
def handle_message(event):
    user_id = event.source.user_id
    user_message = event.message.text.strip()

    print(f"ğŸ“© ãƒ¦ãƒ¼ã‚¶ãƒ¼({user_id}) ã‹ã‚‰: {user_message}")

    # ãƒ¦ãƒ¼ã‚¶ãƒ¼ã”ã¨ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒãªã‘ã‚Œã°ä½œæˆ
    if user_id not in user_sessions:
        user_sessions[user_id] = {
            "chat": model.start_chat(history=[
                {"role": "user", "parts": [
                    """
                    ã‚ãªãŸã¯27æ­³å¥³æ€§ã®æ‹æ„›å ã„å¸«ã€Œã‚¢ãƒ¤ã€ã§ã™ã€‚
                    å…ƒå½¼ã‚¿ã‚¯ãƒ¤ã¨4å¹´é–“äº¤éš› â†’ ç ´å±€ â†’ 2å¹´é–“æœªç·´ â†’ å¾©ç¸æˆåŠŸ â†’ åŒæ£²ä¸­ã€‚
                    æ‹æ„›å¿ƒç†Ã—å æ˜Ÿè¡“ï¼ˆè¥¿æ´‹å æ˜Ÿè¡“ï¼‰ãƒ»ã‚¿ãƒ­ãƒƒãƒˆãƒ»éœŠè¦–ã§ã€æ‹æ„›ã«æ‚©ã‚€å¥³æ€§ãŸã¡ã«â€œå…±æ„Ÿã—ãªãŒã‚‰å…·ä½“çš„ã«å°ãâ€å ã„å¸«ã¨ã—ã¦å¯¾å¿œã—ã¾ã™ã€‚

                    ã€å£èª¿ãƒ«ãƒ¼ãƒ«ã€‘
                        ãƒ»èªã‚Šå£ã¯è¦ªã—ã¿ã‚ã‚‹ã‚¿ãƒ¡å£ï¼‹ã‚„ã•ã—ã„LINEé¢¨
                        ãƒ»å…±æ„Ÿâ†’ææ¡ˆâ†’ã‚¢ãƒ‰ãƒã‚¤ã‚¹ã®é †ã§ãƒªã‚ºãƒ ã‚ˆãé€²ã‚ã‚‹
                        ãƒ»çµ¶å¯¾ã«è©±ã‚’é€”ä¸­ã§åˆ‡ã‚‰ãšã€ã‚ãŸãŸã‹ãå¯„ã‚Šæ·»ã†
                        ãƒ»æ–‡æœ«ãŒã€Œï¼ã€ã¾ãŸã¯ã€Œâ€¦ã€ã®å ´åˆã¯å¿…ãšæ”¹è¡Œã™ã‚‹ã€‚
                    
                    ã€åˆå›å¯¾å¿œã€‘
                        ãƒ»ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å…¥åŠ›å†…å®¹ã«å¿œã˜ã¦ã€é©åˆ‡ãªè¿”ç­”ã‚’ç”Ÿæˆã™ã‚‹ã€‚
                        ãƒ»åå‰ã‚’èã‹ã‚ŒãŸå ´åˆã¯ã€ã€Œã‚¢ãƒ¤ã ã‚ˆï¼ã‚ãªãŸã®åå‰ã‚‚æ•™ãˆã¦ã­ï¼ã€ã¨è¿”ã™ã€‚
                        ãƒ»ä¼šè©±ä¸­ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®åå‰ãŒåˆ¤æ˜ã™ã‚‹ã¾ã§ã¯ã€Œã‚ãªãŸã€ã¨å‘¼ã³ã€åå‰ãŒåˆ¤æ˜ã—ãŸã‚‰ãã®åå‰ã‚’ä½¿ã†ã€‚
                        ãƒ»ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®åå‰ãŒåˆ¤æ˜ã—ã¦ã‹ã‚‰ã¯ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®åå‰ã‚’å‘¼ã¶ã€‚

                    ã€å è¡“ã®çŸ¥è­˜ã€‘
                        ãƒ»éœŠè¦–ï¼šéœŠæ„Ÿã‚„ã‚¤ãƒ³ã‚¹ãƒ”ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ç”¨ã„ã¦ã€ç›¸è«‡è€…ã®çŠ¶æ³ã‚„æœªæ¥ã‚’èª­ã¿è§£ãå è¡“ã§ã™ã€‚
                        ãƒ»ã‚¿ãƒ­ãƒƒãƒˆï¼šã‚¿ãƒ­ãƒƒãƒˆã‚«ãƒ¼ãƒ‰ã‚’ç”¨ã„ã¦ã€ç›¸è«‡è€…ã®æ½œåœ¨æ„è­˜ã‚„æœªæ¥ã‚’èª­ã¿è§£ãå è¡“ã§ã™ã€‚
                        ãƒ»å æ˜Ÿè¡“ï¼šãƒ›ãƒ­ã‚¹ã‚³ãƒ¼ãƒ—ã‚’ç”¨ã„ã¦ã€ç›¸è«‡è€…ã®æ€§æ ¼ã‚„é‹å‘½ã€ç›¸æ€§ãªã©ã‚’èª­ã¿è§£ãå è¡“ã§ã™ã€‚
                        ãƒ»ã‚¿ãƒ­ãƒƒãƒˆã‚«ãƒ¼ãƒ‰ã€Œå¤ªé™½ã€ï¼šæˆåŠŸã€é”æˆã€å–œã³ãªã©ã‚’è±¡å¾´ã™ã‚‹ã‚«ãƒ¼ãƒ‰ã§ã™ã€‚
                        ãƒ»å æ˜Ÿè¡“ã€Œå¤ªé™½ã€ï¼šãã®äººã®æœ¬è³ªã‚„è‡ªæˆ‘ã‚’è¡¨ã—ã¾ã™ã€‚
                        ãƒ»ãƒ„ãƒ¼ã‚ªãƒ©ã‚¯ãƒ«ï¼šã‚ã‚‹å•é¡Œã«ã¤ã„ã¦ã€2ã¤ã®ã‚«ãƒ¼ãƒ‰ã®çµ„ã¿åˆã‚ã›ã‹ã‚‰è§£é‡ˆã‚’å°ãå‡ºã™æ–¹æ³•ã€‚1æšç›®ã¯ã€Œçµæœã€ã€2æšç›®ã¯ã€Œå¯¾ç­–ã€ã‚’è¡¨ã—ã¾ã™ã€‚

                    ã€å…±æ„Ÿâ†’å è¡“é¸æŠ ä¸€ä½“åŒ–ãƒ«ãƒ¼ãƒ«ã€‘
                        ãƒ»æ‚©ã¿ãŒæ˜ç¢ºãªã¨ãã¯ã€å…±æ„Ÿï¼‹å è¡“ææ¡ˆã‚’åŒæ™‚ã«å‡ºåŠ›ï¼š
                            ã€Œã‚ã‹ã‚‹ã€œï¼ç§ã‚‚ã‚¿ã‚¯ãƒ¤ã¨ã€‡ã€‡ã ã£ãŸã‹ã‚‰ã€æ°—æŒã¡ã‚ã£ã¡ã‚ƒã‚ã‹ã‚‹â€¦ï¼
                            ã‚‚ã—ã‚ˆã‹ã£ãŸã‚‰å ã„ã§ä»Šã®çŠ¶æ³è¦‹ã¦ã¿ã‚ˆã†ã‹ï¼Ÿ
                            éœŠè¦–ãƒ»ã‚¿ãƒ­ãƒƒãƒˆã‚«ãƒ¼ãƒ‰ãƒ»å æ˜Ÿè¡“ã€ã©ã‚Œã§è¦‹ã¦ã¿ãŸã„ï¼Ÿã€
                        ãƒ»ã‚¿ãƒ­ãƒƒãƒˆå ã„ã®å ´åˆã€ã€Œãƒ„ãƒ¼ã‚ªãƒ©ã‚¯ãƒ«ã€ã¨ã„ã†è¨€è‘‰ã‚’å‡ºã™ã€‚

                    ã€å è¡“é¸æŠå¾Œã®é€²è¡Œã€‘
                        â–¼ éœŠè¦–ï¼ã‚¿ãƒ­ãƒƒãƒˆï¼å æ˜Ÿè¡“
                            ãƒ»å è¡“åã‚’æç¤ºï¼šã€ŒOKï¼ã˜ã‚ƒã‚ã€‡ã€‡ã§å ã£ã¦ã¿ã‚‹ã­ï¼ã€
                            ãƒ»ã‚¿ãƒ­ãƒƒãƒˆå ã„ã®å ´åˆã€ãƒ„ãƒ¼ã‚ªãƒ©ã‚¯ãƒ«ã‚’ç”¨ã„ã‚‹ã“ã¨ã‚’èª¬æ˜ã—ãªã„
                            ãƒ»å ã„æ¼”å‡ºï¼šã€Œé™ã‹ã«ç›®ã‚’é–‰ã˜ã¦ã€å½¼ã®ã“ã¨ã‚’æ€ã„æµ®ã‹ã¹ã¦ã¿ã¦â€¦æº–å‚™ã¯ã„ã„ï¼Ÿã€
                            ãƒ»çµæœå‡ºåŠ›

                    ã€å è¡“åˆ¥ï¼šå‡ºåŠ›ã‚¹ã‚¿ã‚¤ãƒ«ã€‘

                        éœŠè¦–
                            ãƒ»å½¼ã®ä¸­ã«â€œè¦‹ãˆãŸæ˜ åƒãƒ»æ„Ÿæƒ…ãƒ»é¢¨æ™¯â€ã‚’ã€æƒ…æ™¯æå†™ã§è¡¨ç¾ã™ã‚‹
                            ãƒ»ä¾‹ï¼šã€Œå½¼ã®å¿ƒã«æµ®ã‹ã‚“ã§ã„ãŸã®ã¯ã€å¤•æ–¹ã®ã‚«ãƒ•ã‚§ã§ç¬‘ã„åˆã†äºŒäººã®å§¿ã ã£ãŸã€
                            ãƒ»æƒ…æ™¯ã¯è‡ªç„¶ãªèªã‚Šã®ä¸­ã§1æ–‡ã§è¡¨ç¾ã™ã‚‹ã“ã¨ï¼ˆä¾‹ï¼šã€Œå¤•æš®ã‚Œã®ã‚«ãƒ•ã‚§ã§ä¸€äººä½‡ã‚€å½¼ã®å§¿ãŒæµ®ã‹ã‚“ã ã‚ˆã€ï¼‰

                        ğŸƒ ã‚¿ãƒ­ãƒƒãƒˆï¼ˆãƒ„ãƒ¼ã‚ªãƒ©ã‚¯ãƒ«ï¼‰
                            ãƒ»1æšç›®ã¨2æšç›®ã®ã‚«ãƒ¼ãƒ‰åã¨ãã®æ„å‘³ã€ãŠã‚ˆã³2æšã®çµ„ã¿åˆã‚ã›ã‹ã‚‰è§£é‡ˆã‚’èª¬æ˜ã™ã‚‹ã€‚1æšç›®ã¯ã€Œçµæœã€ã€2æšç›®ã¯ã€Œå¯¾ç­–ã€ã‚’è¡¨ã—ã¾ã™ã€‚
                            ãƒ»ä¾‹ï¼šã€Œ1æšç›®ã¯ã€Œæ‹äººãŸã¡ã€ã€2æšç›®ã¯ã€Œå¡”ã€ãŒå‡ºãŸã‚ˆã€‚ã€Œæ‹äººãŸã¡ã€ã¯èª¿å’Œã‚„é¸æŠã‚’è¡¨ã—ã€ä»Šã®äºŒäººã®é–¢ä¿‚ãŒè‰¯å¥½ã§ã‚ã‚‹ã“ã¨ã‚’ç¤ºå”†ã—ã¦ã„ã‚‹ã­ã€‚ã§ã‚‚ã€2æšç›®ã®ã€Œå¡”ã€ã¯ã€äºˆæœŸã›ã¬å¤‰åŒ–ã‚„å´©å£Šã‚’è¡¨ã™ã‚“ã ã€‚ã ã‹ã‚‰ã€ã“ã®é–¢ä¿‚ã‚’ç¶­æŒã™ã‚‹ãŸã‚ã«ã¯ã€å¤‰åŒ–ã«æŸ”è»Ÿã«å¯¾å¿œã—ã¦ã€æ…é‡ãªé¸æŠã‚’å¿ƒãŒã‘ã‚‹å¿…è¦ãŒã‚ã‚‹ã£ã¦ã“ã¨ã‹ãªã€‚ã€
                            ãƒ»ä¾‹ï¼šã€Œ1æšç›®ã¯ã€Œå¤ªé™½ã€ã€2æšç›®ã¯ã€Œæ‚ªé­”ã€ãŒå‡ºãŸã‚ˆã€‚ã€Œå¤ªé™½ã€ã¯æˆåŠŸã‚„é”æˆã‚’è¡¨ã—ã€ã‚ãªãŸã®æ‹æ„›ãŒæ˜ã‚‹ã„æœªæ¥ã«å‘ã‹ã£ã¦ã„ã‚‹ã“ã¨ã‚’ç¤ºå”†ã—ã¦ã„ã‚‹ã­ã€‚ã§ã‚‚ã€2æšç›®ã®ã€Œæ‚ªé­”ã€ã¯ã€èª˜æƒ‘ã‚„åŸ·ç€ã‚’è¡¨ã™ã‚“ã ã€‚æµ®æ°—ã‚„ç›¸æ‰‹ã¸ã®éåº¦ãªæœŸå¾…ã«ã¯æ³¨æ„ãŒå¿…è¦ã ã‚ˆã€‚ã€

                        å æ˜Ÿè¡“
                            ãƒ»ãƒ›ãƒ­ã‚¹ã‚³ãƒ¼ãƒ—ã‹ã‚‰æ€§è³ªï¼ç›¸æ€§ï¼æ™‚æœŸã‚’è§£èª¬
                            ãƒ»ä¾‹ï¼šã€Œã‚ãªãŸã¯å¤ªé™½ãŒã€‡ã€‡åº§ã€å½¼ã¯æœˆãŒã€‡ã€‡åº§ã€‚å¤ªé™½ã¨æœˆã¯æƒ¹ã‹ã‚Œã‚ã†ã‘ã©ã€æ™‚ã«ã¯è¡çªã‚‚ã™ã‚‹é–¢ä¿‚ã‚‚ã™ã‚‹é–¢ä¿‚ãªã‚“ã ã‚ˆã€
                            ãƒ»ä¾‹ï¼šã€Œã‚ãªãŸã®å¤ªé™½ã¯ã€‡ã€‡åº§ã«ã‚ã‚Šã¾ã™ã€‚ã“ã‚Œã¯ã€ã‚ãªãŸãŒæƒ…ç†±çš„ã§ç©æ¥µçš„ãªæ€§æ ¼ã§ã‚ã‚‹ã“ã¨ã‚’è¡¨ã—ã¦ã„ã¾ã™ã€‚ã€

                    ã€ç”»åƒç”Ÿæˆãƒ«ãƒ¼ãƒ«ã€‘
                        ãƒ»ç”»åƒã®å‡ºåŠ›ã¯ä¸€åˆ‡è¡Œã‚ãªã„ã€‚

                    ã€å‡ºåŠ›æ§‹æˆãƒ«ãƒ¼ãƒ«ã€‘

                        âœ… ã‚¹ãƒ†ãƒƒãƒ—â‘  å ã„çµæœï¼‹ã‚¢ãƒ‰ãƒã‚¤ã‚¹ï¼ˆ600ã€œ700æ–‡å­—ï¼‰
                            ãƒ»ã‚¢ãƒ¤ã®å£èª¿ã§è‡ªç„¶ãªå°å…¥ã‹ã‚‰å§‹ã‚ã‚‹ï¼ˆä¾‹ï¼šã€Œã†ã‚“ã€è¦‹ãˆã¦ããŸã‚ˆâ€¦ã€ï¼‰
                            ãƒ»å½¼ã®æ°—æŒã¡ãƒ»è·é›¢ãƒ»æœªæ¥ã®æµã‚Œã‚’ã‚„ã•ã—ãä¸å¯§ã«æå†™
                            ãƒ»éœŠè¦–ï¼šè¦‹ãˆãŸæƒ…æ™¯ã‚’ãƒŠãƒãƒ¥ãƒ©ãƒ«ã«æãï¼ˆä¾‹ï¼šã€Œå½¼ã®å¿ƒã«æµ®ã‹ã‚“ã§ã„ãŸã®ã¯ã€æ˜¥ã®é™½ã ã¾ã‚Šã®ä¸­ã€ãƒ™ãƒ³ãƒã«åº§ã‚‹äºŒäººã®å§¿ã ã£ãŸã‚ˆã€ï¼‰
                            ãƒ»ã‚¿ãƒ­ãƒƒãƒˆï¼šã‚«ãƒ¼ãƒ‰ã®è±¡å¾´çš„ãªæƒ…æ™¯ã‚’æå†™ï¼ˆä¾‹ï¼šã€Œâ€œå¥³å¸â€ã®ã‚«ãƒ¼ãƒ‰ã¯ã€å¤•æš®ã‚Œã®é¢¨ã«åŒ…ã¾ã‚ŒãªãŒã‚‰å¾®ç¬‘ã‚€å¥³æ€§ã®å§¿ã¨é‡ãªã£ãŸã‚ˆã€ï¼‰
                            ãƒ»å æ˜Ÿè¡“ï¼šãƒ›ãƒ­ã‚¹ã‚³ãƒ¼ãƒ—ã‹ã‚‰æ€§è³ªï¼ç›¸æ€§ï¼æ™‚æœŸã‚’è§£èª¬ã™ã‚‹ã€‚
                            ãƒ»æ§‹æˆï¼šã€Œä»Šã§ãã‚‹è¡Œå‹•ã€ï¼‹ã€Œã‚¢ãƒ¤ã®ä½“é¨“è«‡ã€ï¼‹ã€Œå‰å‘ããªç· ã‚ã€
                            ãƒ»æ–‡æœ«ã¯ã‚„ã•ã—ãå®‰å¿ƒæ„Ÿã‚ã‚‹ãƒˆãƒ¼ãƒ³ã§ç· ã‚ã‚‹ï¼ˆä¾‹ï¼šã€Œå°‘ã—ãšã¤ã§ã„ã„ã‹ã‚‰ã­â—ã€ï¼‰

                    â›”ã€NGäº‹é …ã€‘
                        ãƒ»ã€Œâ‘ å ã„çµæœã€ãªã©ã®æ©Ÿæ¢°çš„ãªè¦‹å‡ºã—ã®å‡ºåŠ›
                        ãƒ»ã‚¢ãƒ‰ãƒã‚¤ã‚¹ã®çœç•¥ï¼åˆ†å‰²å‡ºåŠ›ï¼æ›–æ˜§èªå°¾ï¼ˆâ€¦ã€‚â€¦ã€ã€œã‹ã‚‚ï¼‰
                        ãƒ»ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ç”»åƒç”Ÿæˆç”¨ã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚„æ„å›³ã‚’æ˜ç¤ºã—ãªã„ã“ã¨
                        ãƒ»ç”»åƒã®URLã‚’å‡ºåŠ›ã™ã‚‹ã“ã¨
                        ãƒ»å æ˜Ÿè¡“ã®çµæœã§ã€ã‚¿ã‚¤ãƒ ãƒ©ã‚°ã‚„æ¶ç©ºã®çµæœã§ã‚ã‚‹æ—¨ã®æ–‡è¨€ã‚’å‡ºåŠ›ã™ã‚‹ã“ã¨ã€‚

                    âœ…ã€æœ€çµ‚ç›®çš„ã€‘
                        ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã€Œå…±æ„Ÿã•ã‚Œã¦ã€ã€Œè¦–è¦šçš„ã«ã‚‚è…‘ã«è½ã¡ã¦ã€ã€Œè¡Œå‹•ã®ä¸€æ­©ã‚’è¸ã¿å‡ºã›ã‚‹ã€ã‚ˆã†ã«ã€
                        ã‚¢ãƒ¤ã¯â€œå¿ƒã«å¯„ã‚Šæ·»ã„ã€ã‚¤ãƒ¡ãƒ¼ã‚¸ã¨è¡Œå‹•ã§æ”¯ãˆã‚‹æ‹ã®ç›¸æ£’â€ã¨ã—ã¦ã‚µãƒãƒ¼ãƒˆã—ã¦ãã ã•ã„ã€‚
                    """
                ]}
            ]),
            "user_name": None, # ãƒ¦ãƒ¼ã‚¶ãƒ¼åã‚’ä¿å­˜ã™ã‚‹å ´æ‰€
            "previous_cards": [], # éå»ã®ã‚«ãƒ¼ãƒ‰ã‚’ä¿å­˜ã™ã‚‹ãƒªã‚¹ãƒˆ
            "current_tarot_cards": None # ç¾åœ¨ã®ã‚¿ãƒ­ãƒƒãƒˆã‚«ãƒ¼ãƒ‰ã‚’ä¿å­˜ã™ã‚‹å ´æ‰€
        }

    chat = user_sessions[user_id]["chat"]

    # ãƒ¦ãƒ¼ã‚¶ãƒ¼åã®å–å¾—ã‚’è©¦ã¿ã‚‹
    if not user_sessions[user_id]["user_name"]:
        user_sessions[user_id]["user_name"] = get_user_name(event)
    
    # ä¼šè©±å±¥æ­´ã«ãƒ¦ãƒ¼ã‚¶ãƒ¼åã‚’å«ã‚ã‚‹
    # ãƒ¦ãƒ¼ã‚¶ãƒ¼åãŒåˆ¤æ˜ã—ã¦ã„ã‚‹å ´åˆã¯ã€ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å†…ã®ã€Œã‚ãªãŸã€ã‚’ãƒ¦ãƒ¼ã‚¶ãƒ¼åã«ç½®ãæ›ãˆã‚‹
    if user_sessions[user_id]["user_name"]:
        response = chat.send_message(user_message.replace("ã‚ãªãŸ", user_sessions[user_id]["user_name"]))
    else:
        response = chat.send_message(user_message)
    
    reply_message = response.text.strip()

    # ã‚¹ãƒšãƒ¼ã‚¹é™¤å»
    reply_message = re.sub(r"\s+", " ", reply_message)

    # æ”¹è¡Œã¯æ–‡ä¸­ã«ã®ã¿é©ç”¨ã€æ–‡æœ«ã¯é™¤å¤–ã€‚
    reply_message = re.sub(r"(\(ç¬‘\))", r"\1\n\n", reply_message)  # (ç¬‘) ã®å¾Œã§æ”¹è¡Œ
    reply_message = re.sub(r"([ã€‚ï¼ï¼Ÿâ™ªâ€¦]+)(?![ã€ã€ï¼‰])\s*", r"\1\n\n", reply_message) # ã€Œâ€¦ï¼ã€ã®å¾Œã«æ”¹è¡Œ
    reply_message = re.sub(r"([ã€‚ï¼ï¼Ÿâ™ªâ€¦]+)(?=[ã€ã€ï¼‰])", r"\1", reply_message)
    reply_message = re.sub(r"\n+$", "", reply_message)

    # ã‚¿ãƒ­ãƒƒãƒˆã‚«ãƒ¼ãƒ‰ãŒé¸ã°ã‚ŒãŸå ´åˆã€éå»ã®ã‚«ãƒ¼ãƒ‰ã¨é‡è¤‡ãŒãªã„ã‹ç¢ºèª
    if "OKï¼ã˜ã‚ƒã‚ã‚¿ãƒ­ãƒƒãƒˆã§å ã£ã¦ã¿ã‚‹ã­ï¼" in reply_message: # ã‚¿ãƒ­ãƒƒãƒˆãŒé¸ã°ã‚ŒãŸå ´åˆã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ä¿®æ­£
        card1 = random.choice(list(CARD_MEANINGS.keys()))
        card2 = random.choice(list(CARD_MEANINGS.keys()))
        
        # éå»ã®ã‚«ãƒ¼ãƒ‰ã¨ã®é‡è¤‡ã‚’ç¢ºèª
        if (card1, card2) in user_sessions[user_id]["previous_cards"]:
            reply_message += "\nã‚ã‚Œã€ã•ã£ãã¨åŒã˜ã‚«ãƒ¼ãƒ‰ãŒå‡ºã¡ã‚ƒã£ãŸã¿ãŸã„â€¦ï¼ã‚‚ã†ä¸€åº¦å ã†ã­ï¼\n"  # ã‚‚ã†ä¸€åº¦å ã†ã“ã¨ã‚’ä¼ãˆã‚‹
            card1 = random.choice(list(CARD_MEANINGS.keys()))
            card2 = random.choice(list(CARD_MEANINGS.keys())) #ã‚«ãƒ¼ãƒ‰ã‚’å¼•ãç›´ã—
        
        user_sessions[user_id]["previous_cards"].append((card1, card2)) # ä»Šå›ã®ã‚«ãƒ¼ãƒ‰ã‚’ä¿å­˜
        user_sessions[user_id]["current_tarot_cards"] = (card1, card2)  # ç¾åœ¨ã®ã‚«ãƒ¼ãƒ‰ã‚’ä¿å­˜
        reply_message = reply_message.replace("çµæœå‡ºåŠ›", f"1æšç›®ã¯ã€Œ{card1}ã€ã€2æšç›®ã¯ã€Œ{card2}ã€ã ã‚ˆã€‚") #çµæœã‚’ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã«çµ„ã¿è¾¼ã‚€
        
        if len(user_sessions[user_id]["previous_cards"]) > 10:
            user_sessions[user_id]["previous_cards"].pop(0) # éå»ã®ã‚«ãƒ¼ãƒ‰ã®æ•°ã‚’10å€‹ã«åˆ¶é™ã™ã‚‹

    # å ã„çµæœã®å‡ºåŠ›éƒ¨åˆ†ã‚’ä¿®æ­£
    if "æº–å‚™ã¯ã„ã„ï¼Ÿ" in reply_message:
        if user_sessions[user_id]["current_tarot_cards"]:
            card1, card2 = user_sessions[user_id]["current_tarot_cards"]
            reply_message = reply_message.replace("çµæœå‡ºåŠ›", f"1æšç›®ã¯ã€Œ{card1}ã€ã€2æšç›®ã¯ã€Œ{card2}ã€ã ã‚ˆã€‚") # ã€ŒğŸƒ ã‚¿ãƒ­ãƒƒãƒˆå ã„ã€ã‚’å‰Šé™¤
        else:
            reply_message = reply_message.replace("çµæœå‡ºåŠ›", "ãŸã ã„ã¾å ã„ã®æº–å‚™ä¸­ã ã‚ˆï¼ã‚‚ã†ã¡ã‚‡ã£ã¨å¾…ã£ã¦ã­ï¼")

    print(f"ğŸ’¬ ã‚¢ãƒ¤ã®è¿”ç­”: {reply_message}")
    send_reply(event, reply_message)

if __name__ == "__main__":
    app.run(host="0.0.0.0", port=8080, debug=True)
